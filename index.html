<!DOCTYPE html> 
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Programa de Indica√ß√£o ‚Äî Vitaclin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#f3e3d3">

  <style>
    /* ================= RESET & VARS ================= */
    :root {
      --bg-soft: #f3e3d3;
      --bg-soft-2: #f9efe4;
      --bg-strong: #c59a70;
      --accent: #0f766e;
      --accent-2: #16a34a;
      --accent-dark: #022c22;
      --text-main: #111827;
      --text-soft: #4b5563;
      --card-bg: #ffffff;
      --border-soft: #e5e7eb;
      --radius-lg: 18px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { margin:0; padding:0; font-family: system-ui, -apple-system, sans-serif; }
    
    body {
      background: linear-gradient(180deg, var(--bg-soft-2) 0%, var(--bg-soft) 30%, #eef3ee 100%);
      color: var(--text-main);
      overflow-x: hidden;
    }
    .page { min-height: 100vh; display: flex; flex-direction: column; }

    /* spans criados pelo SplitText */
    .split-word {
      display: inline-block;
      white-space: nowrap;
    }
    .split-char {
      display: inline-block;
      will-change: transform, opacity;
    }
    .hero-title .highlight .split-char {
      background: linear-gradient(120deg, #047857, #22c55e);
      -webkit-background-clip: text;
      color: transparent;
    }

    /* HEADER */
    header {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(14px);
      background: linear-gradient(
        135deg,
        rgba(243,227,211,0.98) 0%,
        rgba(247,233,216,0.98) 30%,
        rgba(236,212,186,0.98) 60%,
        rgba(207,168,122,0.98) 100%
      );
      border-bottom: 1px solid rgba(148,163,184,0.25);
    }

    .header-inner {
      max-width: 1120px;
      margin: 0 auto;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      position: relative;
      z-index: 1;
    }

    .logo-area { display: flex; align-items: center; gap: 10px; }
    .logo-area img {
      height: 122px; /* +35% em rela√ß√£o aos 90px originais */
      border-radius: 8px;
    }

    .logo-text { display: flex; flex-direction: column; gap: 2px; }
    .logo-text span:first-child { font-weight: 700; font-size: 11px; text-transform: uppercase; color: var(--accent); }
    .logo-text span:last-child { font-weight: 600; font-size: 14px; color: #111827; }

    /* NAV DOCK (deslizando pro lado) */
    nav.dock-nav {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      background: radial-gradient(circle at top,
        rgba(255,255,255,0.96),
        rgba(243,227,211,0.96),
        rgba(197,154,112,0.96)
      );
      border: 1px solid rgba(148,163,184,0.45);
      box-shadow: 0 14px 34px rgba(15,23,42,0.28);
      backdrop-filter: blur(18px);

      overflow-x: auto;
      max-width: 100%;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    nav.dock-nav::-webkit-scrollbar {
      display: none;
    }

    nav.dock-nav a {
      position: relative;
      text-decoration: none;
      color: var(--text-soft);
      padding: 8px 14px;
      border-radius: 999px;
      white-space: nowrap;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 10px 24px rgba(15,23,42,0.22);
      transform-origin: center bottom;
      transform: translateY(0) scale(1);
      transition:
        transform 0.16s ease-out,
        box-shadow 0.16s ease-out,
        background 0.16s ease-out,
        color 0.16s ease-out,
        border-color 0.16s ease-out;
    }

    nav.dock-nav a:hover {
      transform: translateY(-3px) scale(1.04);
      box-shadow: 0 18px 40px rgba(15,23,42,0.35);
      background: linear-gradient(135deg,
        rgba(243,227,211,0.98),
        rgba(205,162,121,0.98)
      );
      border-color: rgba(181,135,92,0.95);
      color: #111827;
    }

    nav.dock-nav a.dock-active {
      transform: translateY(-3px) scale(1.04);
      background: linear-gradient(135deg,
        rgba(21,128,61,0.15),
        rgba(34,197,94,0.45)
      );
      border-color: rgba(34,197,94,0.85);
      color: #022c22;
      box-shadow: 0 19px 40px rgba(15,23,42,0.38);
    }

    nav.dock-nav a:focus-visible {
      outline: 2px solid rgba(34,197,94,0.9);
      outline-offset: 2px;
    }

    /* ===== EFEITO DE ESTRELAS VERDES (HERO) ===== */
    .hero-star-wrap {
      position: relative;
      display: block;
      border-radius: 24px;
      padding: 4px;
      overflow: visible;
      border: 2px solid #047857; /* borda verde */
    }

    .hero-star-wrap > .hero-right {
      position: relative;
      z-index: 2;
    }

    .hero-star-wrap::before,
    .hero-star-wrap::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
      mix-blend-mode: screen;
      opacity: 0.95;
      background-repeat: no-repeat;
      background-size: 190% 190%;
      background-image:
        radial-gradient(circle at 20% 0%, rgba(34,197,94,0.85) 0%, transparent 55%),
        radial-gradient(circle at 80% 100%, rgba(45,212,191,0.7) 0%, transparent 60%);
    }

    .hero-star-wrap::before {
      animation: star-orbit 4.6s linear infinite;
    }

    .hero-star-wrap::after {
      animation: star-orbit 4.6s linear infinite reverse;
      opacity: 0.75;
    }

    @keyframes star-orbit {
      0%   { background-position:   0%  50%; }
      25%  { background-position:  50% 100%; }
      50%  { background-position: 100%  50%; }
      75%  { background-position:  50%   0%; }
      100% { background-position:   0%  50%; }
    }

    .section { max-width:1120px; margin: 0 auto 18px; padding: 0 16px; }
    .section h2 { font-size:22px; margin-bottom:6px; letter-spacing:-0.01em; color: #0f172a; }
    .section p.section-sub { font-size:14px; color:var(--text-soft); margin-top:0; }

    /* HERO */
    .hero {
      max-width: 1120px;
      margin: 24px auto 20px;
      padding: 24px;
      border-radius: 26px;
      background: radial-gradient(circle at top left, #fdf5ec 0, #f0ddc8 40%, #e2cfb7 100%);
      box-shadow: 0 20px 48px rgba(120,53,15,0.35);
      gap: 32px;
    }
    .hero-left { padding: 4px; position: relative; text-align: left; }
    .hero-title {
      margin-top: 10px;
      font-size: 28px;
      line-height: 1.1;
      font-weight: 800;
      letter-spacing: -0.02em;
      color: #0f172a;
      text-align: left;
    }
    .hero-title span.highlight {
      background: linear-gradient(120deg, #047857, #22c55e);
      -webkit-background-clip: text;
      color: transparent;
    }
    .hero-sub { margin-top: 10px; font-size: 14px; color: var(--text-soft); max-width: 460px; }
    .hero-perks { margin-top: 16px; display: grid; gap: 8px; font-size: 12px; }
    .hero-perks div { display:flex; align-items:flex-start; gap:8px; color: #1f2933; }
    .hero-perks div span.icon { width:16px; height:16px; border-radius:999px; background: #bbf7d0; display:flex; align-items:center; justify-content:center; font-size:11px; }
    .hero-cta-row { margin-top: 18px; display:flex; flex-wrap: wrap; align-items:center; gap:10px; }
    .hero-small-text { font-size: 11px; color: var(--text-soft); }

    .hero-right { 
      border-radius: 22px; 
      background: linear-gradient(150deg, var(--accent) 0%, #115e59 40%, var(--accent-dark) 100%); 
      color: #ecfdf5; padding: 20px; 
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.7); 
      position: relative; overflow:hidden; 
      z-index: 1;
    }
    .hero-right-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; font-size:12px; }
    .hero-right-header span.label { text-transform:uppercase; letter-spacing:0.08em; font-weight:600; opacity:0.95; }
    .hero-right-header span.badge { padding:4px 8px; border-radius:999px; background:rgba(15,23,42,0.45); font-size:11px; }
    .hero-right-grid { margin-top:12px; display:grid; grid-template-columns: 1.1fr 1.1fr; gap:10px; font-size:12px; }
    .hero-right-card { border-radius:14px; padding:10px 11px; background:rgba(15,23,42,0.64); border:1px solid rgba(45,212,191,0.4); }
    .hero-right-card h4 { margin:0 0 5px; font-size:11px; text-transform:uppercase; opacity:0.9; }
    .hero-right-card strong { font-size:18px; }
    .hero-right-card small { display:block; font-size:11px; opacity:0.9; margin-top:2px; }
    .hero-right-footer { margin-top:12px; font-size:11px; color:#d1fae5; opacity:0.95; }

    /* DESKTOP */
    @media (min-width: 1000px) {
      .hero {
        display: grid;
        grid-template-columns: 1.4fr 1fr;
      }
      .hero-perks { grid-template-columns: repeat(auto-fit, minmax(170px,1fr)); }
      .steps, .procedures-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
      .field-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    }

    /* MOBILE (zoom forte) */
    @media (max-width: 999px) {
      html, body { font-size: 16px; }

      body {
        transform: scale(2.475);
        transform-origin: top center;
      }
      .page {
        width: 40.5vw;
        margin: 0 auto;
        min-height: auto;
      }

      header {
        position: relative;
        top: auto;
      }

      .header-inner { flex-direction: column; gap: 10px; }

      .hero {
        display: flex;
        flex-direction: column;
        gap: 30px;
      }
      .hero-left { width: 100%; order: 1; }
      .hero-star-wrap { width: 100%; order: 2; }
      .hero-right { width: 100%; }

      .hero-title { font-size: 26px; }
      .hero-perks { grid-template-columns: 1fr; gap: 12px; }

      .btn-primary {
        width: 100%;
        justify-content: center;
        padding: 14px 20px !important;
        font-size: 16px;
      }

      .steps, .procedures-grid, .field-row-2 { 
        display: flex; 
        flex-direction: column; 
        gap: 15px; 
      }

      .admin-remote-controls { flex-direction: column; }
      .admin-remote-controls .field-group-inline { width: 100%; }

      input { padding: 12px 14px !important; font-size: 16px !important; }
    }

    .pill-badge { font-size: 11px; padding: 4px 8px; border-radius: 999px; background: rgba(245,158,11,0.10); color: #92400e; border: 1px solid rgba(180,83,9,0.28); display:inline-flex; align-items:center; gap:6px; }
    .btn-primary { border:none; outline:none; cursor:pointer; padding:10px 18px; border-radius:999px; font-size:14px; font-weight:600; background: linear-gradient(135deg, #15803d, #16a34a); color:#f9fafb; box-shadow: 0 14px 35px rgba(21,128,61,0.35); display:inline-flex; align-items:center; gap:8px; }
    .btn-outline { border-radius:999px; padding:8px 16px; font-size:13px; font-weight:500; background:transparent; border:1px solid #d1d5db; color:#374151; cursor:pointer; }
    .step-section { display:none; animation: fadeIn 0.3s ease; }
    .step-section.active { display:block; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
    .step-card { background: rgba(255,255,255,0.96); border-radius: 20px; padding: 14px; box-shadow: 0 16px 35px rgba(15,23,42,0.06); border: 1px solid rgba(148,163,184,0.35); }
    .step-header { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
    .step-number { width:26px; height:26px; border-radius:999px; background:rgba(16,185,129,0.12); color:#047857; font-size:13px; font-weight:700; display:flex; align-items:center; justify-content:center; }
    .step-title { font-size:15px; font-weight:700; color:#111827; }
    .step-card p { margin:0; font-size:13px; color:var(--text-soft); }
    .step-nav { margin-top:16px; display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap; }

    /* ===== PROCEDIMENTOS ===== */
    .procedures-shell {
      margin-top:14px;
      border-radius:24px;
      padding:14px 14px 16px;
      background: linear-gradient(135deg, var(--accent) 0%, #0f766e 40%, var(--accent-dark) 100%);
      box-shadow: 0 22px 40px rgba(15,23,42,0.55);
      color:#ecfdf5;

      /* para estrelas/verdes nos cantos */
      position: relative;
      overflow: hidden;
      touch-action: manipulation; /* evitar double-tap zoom nessa √°rea */
    }

    /* ILUMINA√á√ïES VERDES NOS CANTOS + ESTRELAS */
    .procedures-shell::before,
    .procedures-shell::after {
      content: '';
      position: absolute;
      inset: -35%;
      pointer-events: none;
      mix-blend-mode: screen;
      background-repeat: no-repeat;
      background-size: 170% 170%;
      opacity: 0.9;
    }

    .procedures-shell::before {
      background-image:
        radial-gradient(circle at 0% 0%, rgba(34,197,94,0.9) 0%, transparent 60%),
        radial-gradient(circle at 25% 110%, rgba(45,212,191,0.7) 0%, transparent 60%);
      animation: star-orbit 5.6s linear infinite;
    }

    .procedures-shell::after {
      background-image:
        radial-gradient(circle at 100% 0%, rgba(74,222,128,0.9) 0%, transparent 60%),
        radial-gradient(circle at 75% 120%, rgba(34,197,94,0.7) 0%, transparent 60%);
      animation: star-orbit 5.6s linear infinite reverse;
      opacity: 0.8;
    }

    .procedures-shell-header { position:relative; z-index:1; margin-bottom:10px; }
    .procedures-shell-header h3 { margin:0; font-size:20px; font-weight:800; }
    .procedures-shell-header p { margin:4px 0 0; font-size:13px; opacity:0.9; }

    .procedures-grid {
      position: relative;
      z-index: 1;
    }

    /* BLOCO DE PROCEDIMENTOS COM GLOW + CLIQUE VERDE */
    .proc-block {
      position: relative;
      background: rgba(15,23,42,0.82);
      border-radius: 18px;
      padding: 10px 12px;
      border: 1px solid rgba(148,163,184,0.5);
      box-shadow: 0 12px 24px rgba(15,23,42,0.6);
      overflow: hidden;
      transform-style: preserve-3d;
      --glow-x: 50%;
      --glow-y: 50%;
      --glow-intensity: 0;
    }

    /* FOCO VERDE COM RAIO MENOR (mais concentrado) */
    .proc-block::after {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: inherit;
      pointer-events: none;
      opacity: var(--glow-intensity);
      background:
        radial-gradient(
          circle at var(--glow-x) var(--glow-y),
          rgba(34,197,94,0.9) 0%,
          rgba(34,197,94,0.45) 13%,
          transparent 30%
        );
      mix-blend-mode: screen;
      transition: opacity 0.25s ease-out;
      z-index: 0;
    }

    .proc-block.magic-proc-active {
      box-shadow:
        0 20px 44px rgba(15,23,42,0.94),
        0 0 40px rgba(34,197,94,0.75);
    }

    .proc-block h3 { margin:0 0 4px; font-size:17px; font-weight:800; color:#e5e7eb; }
    .proc-block ul { margin:0; padding-left:18px; display:flex; flex-direction:column; gap:2px; }

    /* Gradient Text dos itens de procedimentos/atendimentos */
    .proc-block li {
      margin: 0 0 3px;
      font-size: 16px;
      font-weight: 500;
      background-image: linear-gradient(120deg, #22c55e, #bbf7d0);
      background-size: 100% 100%;
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      text-shadow: 0 0 8px rgba(34, 197, 94, 0.55);
    }

    .proc-block li::marker {
      color: #e5e7eb;
    }

    /* ONDA DE CLIQUE VERDE MAIS FORTE */
    .proc-click-wave {
      position: absolute;
      border-radius: 999px;
      pointer-events: none;
      transform: translate(-50%, -50%);
      background: radial-gradient(circle,
        rgba(34,197,94,0.95) 0%,
        rgba(34,197,94,0.55) 30%,
        transparent 70%
      );
      width: 0;
      height: 0;
      opacity: 0.98;
      z-index: 5;
    }

    .form-card { background: radial-gradient(circle at top left, #fefaf7 0, #f8eee2 45%, #f3e7d9 100%); border-radius: 22px; padding: 16px; border: 1px solid rgba(148,163,184,0.45); box-shadow: 0 22px 40px rgba(120,53,15,0.28); margin-top:10px; }
    .form-section-title { font-size:15px; font-weight:700; margin-bottom:6px; }
    .form-section-sub { font-size:12px; color:var(--text-soft); margin-bottom:10px; }
    .field-group { display:flex; flex-direction:column; margin-bottom:8px; gap:2px; }
    label { font-size:11px; font-weight:600; color:#374151; }
    input { border-radius: 999px; border: 1px solid #d1d5db; padding: 7px 10px; font-size:13px; outline:none; background:#f9fafb; width: 100%; }
    input:focus { border-color: var(--accent-2); background:#ffffff; box-shadow: 0 0 0 1px rgba(34,197,94,0.35); }
    
    .indicados-panel { border-radius: 20px; padding: 12px; background: linear-gradient(150deg, var(--accent) 0%, #115e59 40%, var(--accent-dark) 100%); color:#ecfdf5; box-shadow: 0 20px 40px rgba(15,23,42,0.7); border: 1px solid rgba(45,212,191,0.45); margin-bottom:12px; }
    .indicados-title { font-size:15px; font-weight:700; }
    .indicados-sub { font-size:11px; color:#d1fae5; }
    .indicado-item { border-radius: 14px; border:1px solid rgba(209,213,219,0.9); padding:8px; background: #ffffff; margin-bottom: 8px; }
    .indicado-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; font-size:11px; color:#111827; }
    .indicado-tag { font-size:10px; padding:2px 8px; border-radius:999px; background:rgba(22,163,74,0.08); color:#166534; border:1px solid rgba(22,163,74,0.4); }
    .result-box { margin-top:12px; border-radius:18px; padding:14px; background: #ecfdf5; border:1px solid #bbf7d0; font-size:13px; color:#064e3b; display:none; text-align:center; }
    .result-box.show { display:block; }
    .result-code { background:#022c22; color:#ecfdf5; padding:4px 10px; border-radius:999px; font-family:monospace; font-weight:600; display:inline-block; margin-top:4px; }
    .form-actions { margin-top:12px; display:flex; flex-wrap:wrap; align-items:center; gap:10px; justify-content:space-between; }
    .alert { margin-top:8px; font-size:11px; padding:8px; border-radius:10px; display:none; background:#fef2f2; color:#b91c1c; border:1px solid #fecaca; }
    .alert.show { display:block; }

    /* ADMIN */
    .admin-panel { margin-top:12px; border-radius:22px; padding:14px 16px 18px; background:#111827; color:#e5e7eb; box-shadow:0 22px 40px rgba(15,23,42,0.55); border:1px solid rgba(148,163,184,0.6); }
    .admin-panel-header { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px; }
    .admin-panel-title { font-size:16px; font-weight:700; }
    .admin-panel-sub { font-size:11px; color:#9ca3af; margin-top:2px; }
    .admin-clear-btn { border-radius:999px; padding:6px 12px; font-size:11px; border:1px solid #f97373; background:transparent; color:#fecaca; cursor:pointer; }
    .admin-empty { font-size:12px; color:#9ca3af; margin-top:6px; }
    .admin-list { margin-top:8px; display:flex; flex-direction:column; gap:8px; font-size:12px; }
    .admin-card { border-radius:16px; padding:10px 12px; background:#020617; border:1px solid rgba(148,163,184,0.55); }
    .admin-card-header { display:flex; justify-content:space-between; align-items:flex-start; gap:8px; margin-bottom:4px; font-size:12px; }
    .admin-card-title { font-weight:600; color:#e5e7eb; }
    .admin-badge { font-size:10px; padding:2px 8px; border-radius:999px; background:rgba(34,197,94,0.12); color:#bbf7d0; border:1px solid rgba(34,197,94,0.5); white-space:nowrap; }
    .admin-card-meta { font-size:11px; color:#9ca3af; margin-bottom:4px; }
    .admin-card-indicados-title { font-size:11px; font-weight:600; margin-top:4px; margin-bottom:2px; color:#e5e7eb; }
    .admin-card-indicados-list { font-size:11px; color:#d1d5db; margin:0; padding-left:16px; white-space: pre-wrap; }
    
    .admin-remote-controls { margin-top:8px; display:flex; flex-wrap:wrap; gap:8px; align-items:flex-end; }
    .admin-remote-controls .field-group-inline { flex:1 1 160px; display:flex; flex-direction:column; gap:2px; }
    .admin-remote-controls label { color:#e5e7eb; font-size:11px; }
    .admin-remote-controls input { background:#020617; border-color:#4b5563; color:#e5e7eb; }
    .admin-status { margin-top:6px; font-size:11px; color:#9ca3af; }

    .admin-groups { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .admin-group { border-radius:14px; padding:8px 10px; background:#020617; border:1px dashed rgba(148,163,184,0.7); }
    .admin-group-title { display:flex; justify-content:space-between; align-items:center; font-size:12px; font-weight:600; margin-bottom:2px; color:#e5e7eb; }
    .admin-indicador-tag { font-size:10px; color:#9ca3af; }
    .admin-group-meta { font-size:11px; color:#9ca3af; margin-bottom:4px; }

    .admin-indicador-actions {
      margin:4px 0 2px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .admin-indicado-row { padding:4px 0; border-top:1px solid rgba(31,41,55,0.9); font-size:11px; }
    .admin-indicado-row:first-of-type { border-top:none; }
    .admin-indicado-name { display:block; font-weight:500; color:#e5e7eb; }
    .admin-indicado-meta { display:block; color:#9ca3af; }

    .admin-indicado-actions {
      margin-top:4px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .admin-indicado-btn {
      border-radius:999px;
      border:1px solid #4b5563;
      background:#020617;
      color:#e5e7eb;
      font-size:10px;
      padding:3px 8px;
      cursor:pointer;
    }
    .admin-indicado-btn.done {
      border-color:#22c55e;
      color:#bbf7d0;
    }

    /* CARROSSEL ETAPA 2 */
    .carousel-wrapper { margin-top: 18px; }
    .carousel-container {
      position: relative;
      overflow: hidden;
      border-radius: 24px;
      padding: 16px;
      background: radial-gradient(circle at top left, #020617 0, #020617 50%, #020617 100%);
      border: 1px solid rgba(15,23,42,0.7);
      max-width: 420px;
      margin: 0 auto;
    }
    .carousel-track {
      display: flex;
      transition: transform 0.6s cubic-bezier(0.22, 0.61, 0.36, 1);
    }
    .carousel-item {
      flex: 0 0 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border-radius: calc(24px - 12px);
      background: radial-gradient(circle at top left, #111827 0, #020617 65%, #020617 100%);
      border: 1px solid rgba(148,163,184,0.5);
      overflow: hidden;
      cursor: grab;
    }
    .carousel-item:active { cursor: grabbing; }
    .carousel-item-header { margin-bottom: 16px; padding: 20px; padding-top: 20px; }
    .carousel-icon-container {
      display: flex;
      height: 28px;
      width: 28px;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background-color: #fff;
    }
    .carousel-icon { font-size: 16px; color: #060010; line-height: 1; font-weight: 700; }
    .carousel-item-content { padding: 0 20px 20px 20px; }
    .carousel-item-title { margin-bottom: 4px; font-weight: 800; font-size: 16px; color: #f9fafb; }
    .carousel-item-description { font-size: 13px; color: #e5e7eb; }
    .carousel-indicators-container {
      display: flex;
      width: 100%;
      justify-content: center;
      margin-top: 12px;
    }
    .carousel-indicators {
      display: flex;
      gap: 8px;
    }
    .carousel-indicator {
      height: 8px;
      width: 8px;
      border-radius: 50%;
      cursor: pointer;
      transition: background-color 150ms, transform 150ms;
      background-color: #4b5563;
    }
    .carousel-indicator.active {
      background-color: #f9fafb;
      transform: scale(1.2);
    }
    .carousel-indicator.inactive {
      background-color: #4b5563;
    }

    /* ===== GRADIENT TEXT VERDE CLARO (LEMBRETE ETAPA 6) ===== */
    .animated-gradient-text {
      position: relative;
      margin: 4px 0 10px;
      padding: 6px 10px;
      display: flex;
      max-width: 100%;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      border-radius: 1rem;
      font-weight: 600;
      font-size: 12px;
      backdrop-filter: blur(10px);
      overflow: hidden;
    }

    .animated-gradient-text.gradient-lembrar {
      margin-top: 4px;
    }

    .gradient-overlay {
      position: absolute;
      inset: 0;
      background-size: 300% 100%;
      background-image: linear-gradient(
        to right,
        #bbf7d0,
        #4ade80,
        #22c55e,
        #4ade80,
        #bbf7d0
      );
      animation: gradient 8s linear infinite;
      border-radius: inherit;
      z-index: 0;
      pointer-events: none;
    }

    .gradient-overlay::before {
      content: '';
      position: absolute;
      width: calc(100% - 2px);
      height: calc(100% - 2px);
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      border-radius: inherit;
      background-color: #020617;
      z-index: -1;
    }

    .text-content {
      display: inline-block;
      position: relative;
      z-index: 2;
      background-size: 300% 100%;
      background-image: linear-gradient(
        to right,
        #bbf7d0,
        #4ade80,
        #22c55e,
        #4ade80,
        #bbf7d0
      );
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradient 8s linear infinite;
      text-align: center;
    }

    @keyframes gradient {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    footer { margin-top:22px; padding:12px 16px 18px; background:#111827; color:#9ca3af; font-size:11px; text-align:center; }
    .footer-inner a { color:#d1fae5; text-decoration:none; }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js" defer></script>
</head>
<body>
<div class="page">
  <header>
    <div class="header-inner">
     <div class="logo-area">
  <img src="https://raw.githubusercontent.com/mortexxx/vitaclin-brand/refs/heads/main/vitaclin.png" alt="Vitaclin Sa√∫de">
  <div class="logo-text">
    <span>Programa de Indica√ß√£o</span>
    <span>Vitaclin Sa√∫de</span>
  </div>
</div>


      <!-- DOCK deslizando pro lado, igual antes -->
      <nav class="dock-nav">
        <a href="#" data-step="1" onclick="App.goTo(1); return false;">In√≠cio</a>
        <a href="#" data-step="2" onclick="App.goTo(2); return false;">Como funciona</a>
        <a href="#" data-step="3" onclick="App.goTo(3); return false;">Procedimentos</a>
        <a href="#" data-step="4" onclick="App.goTo(4); return false;">Cupom</a>
        <a href="#" data-step="7" onclick="App.checkAdmin(); return false;">Admin</a>
      </nav>
    </div>
  </header>

  <main>
    <!-- ===== ETAPA 1 ===== -->
    <section class="step-section active" data-step="1">
      <div class="hero">
        <div class="hero-left">
          <div class="pill-badge">
            <span>‚ú®</span>
            <span><strong>Quer ganhar at√© 15% de desconto</strong> em servi√ßos privados?</span>
          </div>
          <h1 class="hero-title">
            Indique amigos e familiares e ganhe <span class="highlight">at√© 15% de desconto</span> na Vitaclin.
          </h1>
          <p class="hero-sub">
            Voc√™ indica pessoas que podem se beneficiar dos nossos exames e atendimentos. N√≥s cuidamos do contato e, quando voc√™ utilizar os servi√ßos privados eleg√≠veis, aplicamos o seu desconto. Cada indicado ainda ganha <strong>5% de desconto</strong> em <strong>1 servi√ßo privado eleg√≠vel</strong>, ao informar seu nome na recep√ß√£o, sem somar com o seu desconto de 10% ou 15% no mesmo atendimento.
          </p>
          <div class="hero-perks">
            <div><span class="icon">‚úì</span><span>Programa transparente: voc√™ escolhe quem indicar e pode acompanhar tudo na cl√≠nica.</span></div>
            <div><span class="icon">‚úì</span><span>Desconto crescente para voc√™: quanto mais pessoas indicar, maior o benef√≠cio.</span></div>
            <div><span class="icon">‚úì</span><span>Indica√ß√µes com consentimento, uso respons√°vel dos dados e foco em sa√∫de.</span></div>
          </div>
          <div class="hero-cta-row">
            <button type="button" class="btn-primary" onclick="App.goTo(2)"><span class="icon">‚¨á</span> Ir para pr√≥xima etapa</button>
            <span class="hero-small-text">
              Voc√™ poder√° indicar de 2 a 10 pessoas. Menos de 2 indica√ß√µes n√£o gera desconto.
            </span>
          </div>
        </div>

        <!-- bloco "Simula√ß√£o r√°pida" com estrelas verdes -->
        <div class="hero-star-wrap">
          <aside class="hero-right">
            <div class="hero-right-header">
              <span class="label">Simula√ß√£o r√°pida</span>
              <span class="badge">Indicador</span>
            </div>
            <div class="hero-right-grid">
              <div class="hero-right-card">
                <h4>Voc√™ indica</h4>
                <strong>2 a 4</strong>
                <small>amigos / familiares</small>
                <small>‚Üí <strong>10%</strong> de desconto</small>
              </div>
              <div class="hero-right-card">
                <h4>Voc√™ indica</h4>
                <strong>5 a 7</strong>
                <small>pessoas</small>
                <small>‚Üí <strong>12%</strong> de desconto</small>
              </div>
              <div class="hero-right-card">
                <h4>Voc√™ indica</h4>
                <strong>8 a 10</strong>
                <small>ou mais</small>
                <small>‚Üí <strong>15%</strong> de desconto</small>
              </div>
              <div class="hero-right-card">
                <h4>Seus indicados</h4>
                <strong>5%</strong>
                <small>de desconto em 1 servi√ßo privado eleg√≠vel</small>
                <small>ao informar seu nome na recep√ß√£o</small>
              </div>
            </div>
            <div class="hero-right-footer">
              Para validar as indica√ß√µes, √© obrigat√≥rio informar o <strong>@ do Instagram</strong> do indicador e dos indicados. A equipe poder√° verificar se seguem o perfil oficial <strong>@vitaclinsaude</strong>.
            </div>
          </aside>
        </div>
      </div>
    </section>

    <!-- ===== ETAPA 2 ===== -->
    <section class="section step-section" data-step="2">
      <h2>Como funciona o programa de indica√ß√£o</h2>
      <p class="section-sub">Leia com calma: deixamos tudo simples e em texto maior, para voc√™ entender cada passo.</p>

      <div class="carousel-wrapper">
        <div class="carousel-container" id="benefitsCarousel">
          <div class="carousel-track"></div>
          <div class="carousel-indicators-container">
            <div class="carousel-indicators"></div>
          </div>
        </div>
      </div>

      <div class="step-nav">
        <button class="btn-outline" onclick="App.goTo(1)">Voltar</button>
        <button class="btn-primary" onclick="App.goTo(3)">Pr√≥xima etapa</button>
      </div>
    </section>

    <!-- ===== ETAPA 3 ===== -->
    <section class="section step-section" data-step="3">
      <h2>Procedimentos que podem receber desconto</h2>
      <p class="section-sub">Veja abaixo os principais procedimentos e atendimentos em sa√∫de e est√©tica onde o programa de indica√ß√£o pode gerar benef√≠cio.</p>
      <div class="procedures-shell">
        <div class="procedures-shell-header">
          <h3>Servi√ßos em que o desconto pode ser aplicado</h3>
        </div>
        <div class="procedures-grid">
          <div class="proc-block">
            <h3>Procedimentos</h3>
            <ul>
              <li>Triagem otoneurol√≥gica</li>
              <li>Avalia√ß√£o psicossocial</li>
              <li>Acuidade visual</li>
              <li>Audiometria tonal e vocal</li>
              <li>Audiometria tonal</li>
              <li>Eletrocardiograma</li>
              <li>Eletroencefalograma</li>
              <li>Exames laboratoriais</li>
              <li>Espirometria c/ BO</li>
              <li>Espirometria</li>
              <li>Lavagem otol√≥gica</li>
              <li>Raio-X em geral</li>
              <li>Relat√≥rio psicol√≥gico</li>
            </ul>
          </div>
          <div class="proc-block">
            <h3>Atendimentos</h3>
            <ul>
              <li>Medicina do trabalho</li>
              <li>Seguran√ßa do trabalho</li>
              <li>Cl√≠nica geral</li>
              <li>Fonoaudiologia</li>
              <li>Psicologia</li>
              <li>Nutri√ß√£o</li>
              <li>Psicopedag√≥gico</li>
              <li>Podologia</li>
              <li>Est√©tica</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="step-nav">
        <button class="btn-outline" onclick="App.goTo(2)">Voltar</button>
        <button class="btn-primary" onclick="App.goTo(4)">Pr√≥xima etapa</button>
      </div>
    </section>

    <!-- ===== FORM PRINCIPAL (ETAPA 4, 5, 6) ===== -->
    <form id="mainForm" novalidate onsubmit="App.handleSubmit(event)">
      <!-- ETAPA 4 -->
      <section class="section step-section" data-step="4">
        <h2>Indique amigos e gere seu cupom</h2>
        <p class="section-sub">Primeiro, preencha seus dados.</p>
        <div class="form-card">
          <div class="form-section-title">Seus dados</div>
          <div class="field-group">
            <label>Nome completo <span class="required">*</span></label>
            <input id="nomeIndicador" type="text" required>
          </div>
          <div class="field-row-2">
            <div class="field-group">
              <label>CPF <span class="required">*</span></label>
              <input id="cpfIndicador" type="tel" placeholder="000.000.000-00" required oninput="Masks.cpf(this)">
            </div>
            <div class="field-group">
              <label>Data de nascimento <span class="required">*</span></label>
              <input
                id="nascIndicador"
                type="text"
                required
                inputmode="numeric"
                maxlength="10"
                placeholder="dd/mm/aaaa"
                oninput="Masks.date(this)"
              >
            </div>
          </div>
          <div class="field-row-2">
            <div class="field-group">
              <label>WhatsApp <span class="required">*</span></label>
              <input id="whatsIndicador" type="tel" placeholder="(DD) 9 9999-9999" required oninput="Masks.phone(this)">
            </div>
            <div class="field-group">
              <label>Instagram (ex: @usuario) <span class="required">*</span></label>
              <input id="instaIndicador" type="text" placeholder="@usuario" required>
            </div>
          </div>
          <div class="field-group">
            <label>E-mail</label>
            <input id="emailIndicador" type="email" placeholder="opcional">
          </div>
          <div class="step-nav">
            <button type="button" class="btn-outline" onclick="App.goTo(3)">Voltar</button>
            <button type="button" class="btn-primary" onclick="App.validateStep4()">Pr√≥xima etapa</button>
          </div>
        </div>
      </section>

      <!-- ETAPA 5 (seguir insta) -->
      <section class="section step-section" data-step="5">
        <h2>Siga a Vitaclin no Instagram</h2>
        <p class="section-sub">
          Depois de gerar seu cupom, siga o perfil oficial da Vitaclin no Instagram
          para acompanhar novidades, avisos importantes e outras formas de cuidar da sua sa√∫de.
        </p>
        <div class="form-card" style="text-align:center;">
        <img src="https://raw.githubusercontent.com/mortexxx/vitaclin-brand/refs/heads/main/vitaclin.png"
       alt="Vitaclin Sa√∫de"
       style="max-width:180px; width:60%; margin:0 auto 12px; display:block;">

          <p style="font-size:13px; margin-bottom:14px; color:#374151;">
            Toque no bot√£o abaixo para abrir o Instagram da Vitaclin. Depois de seguir,
            voc√™ pode voltar a esta p√°gina quando quiser.
          </p>
          <button type="button" class="btn-primary" onclick="App.followAndContinue()">
            Seguir @vitaclinsaude
          </button>
        </div>
      </section>

      <!-- ETAPA 6 (indicados) -->
      <section class="section step-section" data-step="6">
        <h2>Pessoas indicadas</h2>
        <p class="section-sub">
          Adicione de 2 a 10 pessoas.
        </p>
        <div class="animated-gradient-text gradient-lembrar">
          <div class="gradient-overlay"></div>
          <div class="text-content">
            Lembre-se: para que os descontos sejam aplicados, voc√™ tamb√©m precisa orientar seus indicados a seguir o Instagram oficial @vitaclinsaude antes do atendimento.
          </div>
        </div>

        <div class="form-card">
          <div class="indicados-panel">
            <div class="indicados-title">Lista de Indica√ß√µes</div>
            <div class="indicados-sub">Cada indicado ganha 5% de desconto.</div>
          </div>
          <div id="indicadosContainer" style="margin-top:12px;"></div>
          <div id="alert" class="alert"></div>
          <div style="margin-top:12px; padding:10px; background:#f9fafb; border-radius:12px;">
             <label style="display:flex; gap:8px; align-items:center; font-size:11px; color:#4b5563;">
                <input type="checkbox" required style="width:auto;">
                <span>Declaro ter permiss√£o para indicar e concordo com as regras.</span>
             </label>
          </div>
          <div id="resultBox" class="result-box"></div>
          <div class="form-actions">
            <button type="button" class="btn-outline" onclick="App.goTo(4)">Voltar</button>
            <button type="submit" class="btn-primary" id="submitBtn">
              <span class="icon">üé´</span> Gerar meu desconto
            </button>
          </div>
        </div>
      </section>
    </form>

    <!-- ===== ETAPA 7 (ADMIN) ===== -->
    <section class="section step-section" data-step="7">
      <h2>Admin ‚Äî registros locais e nuvem</h2>

      <div class="admin-panel admin-panel-remote">
        <div class="admin-panel-header">
          <div>
            <div class="admin-panel-title">Pesquisar na planilha</div>
            <div class="admin-panel-sub">Filtre por indicador, indicado ou WhatsApp.</div>
          </div>
        </div>
        <div class="admin-remote-controls">
          <div class="field-group-inline"><label>Indicador</label><input id="adminIndicador" type="text"></div>
          <div class="field-group-inline"><label>Indicado</label><input id="adminIndicado" type="text"></div>
          <div class="field-group-inline"><label>WhatsApp</label><input id="adminWhats" type="tel"></div>
          <div style="display:flex; gap:6px; margin-top:10px;">
            <button type="button" class="btn-outline" style="border-color:#4b5563; color:#e5e7eb;" onclick="Admin.fetchAll()">Recarregar vis√£o geral</button>
            <button type="button" class="btn-primary" onclick="Admin.searchCloud()">üîç Buscar</button>
          </div>
        </div>
        <div id="adminRemoteStatus" class="admin-status"></div>
        <div id="adminRemoteResults" class="admin-results admin-empty">Nenhum dado filtrado.</div>
      </div>

      <div class="admin-panel admin-panel-remote">
        <div class="admin-panel-header">
          <div>
            <div class="admin-panel-title">Nuvem ‚Äî vis√£o geral</div>
            <div class="admin-panel-sub">Todos os indicadores e indicados que est√£o na planilha (leitura).</div>
          </div>
        </div>
        <div id="adminRemoteAll" class="admin-results admin-empty">Carregando...</div>
      </div>

      <div class="admin-panel">
        <div class="admin-panel-header">
          <div><div class="admin-panel-title">Registros locais</div></div>
          <button type="button" class="admin-clear-btn" onclick="Admin.clearLocal()">Limpar</button>
        </div>
        <div id="adminLocalList" class="admin-list"></div>
        <div id="adminEmptyMsg" class="admin-empty" style="display:none;">Nenhum registro salvo localmente.</div>
      </div>
    </section>
  </main>
  <footer>
    <div class="footer-inner">
      ¬© Vitaclin Sa√∫de.
      <a href="https://www.instagram.com/vitaclinsaude?utm_source=ig_web_button_share_sheet&amp;igsh=ZDNlZDc0MzIxNw==" target="_blank" rel="noopener noreferrer">
        @vitaclinsaude
      </a>
    </div>
  </footer>
</div>
<script>
/* ========== SPLIT TEXT / ANIMA√á√ïES ========== */
function splitTextForAnimation(el) {
  if (!el || !window.gsap) return [];
  if (el.dataset.splitInit === '1') {
    return Array.from(el.querySelectorAll('.split-char'));
  }

  el.dataset.splitInit = '1';
  const originalNodes = Array.from(el.childNodes);
  el.innerHTML = '';
  const chars = [];

  function wrapChars(text, parent) {
    if (!text) return;
    const parts = text.split(/(\s+)/);

    parts.forEach(part => {
      if (!part) return;
      if (/^\s+$/.test(part)) {
        parent.appendChild(document.createTextNode(part));
        return;
      }
      const wordSpan = document.createElement('span');
      wordSpan.className = 'split-word';
      parent.appendChild(wordSpan);
      for (let i = 0; i < part.length; i++) {
        const chSpan = document.createElement('span');
        chSpan.className = 'split-char';
        chSpan.textContent = part[i];
        wordSpan.appendChild(chSpan);
        chars.push(chSpan);
      }
    });
  }

  function walk(node, parent) {
    if (node.nodeType === Node.TEXT_NODE) {
      const text = node.textContent || '';
      if (text.length) wrapChars(text, parent);
    } else if (node.nodeType === Node.ELEMENT_NODE) {
      const clone = node.cloneNode(false);
      parent.appendChild(clone);
      Array.from(node.childNodes).forEach(child => walk(child, clone));
    }
  }

  originalNodes.forEach(n => walk(n, el));
  return chars;
}

function splitTextAndAnimate(target, options) {
  if (!window.gsap) return;

  const opts = Object.assign({
    delay: 0.03,
    duration: 0.45,
    ease: 'power3.out',
    from: { opacity: 0, y: 40 },
    to: { opacity: 1, y: 0 },
    threshold: 0.2,
    rootMargin: -80,
    useScrollTrigger: false
  }, options || {});

  let elements;
  if (typeof target === 'string') elements = document.querySelectorAll(target);
  else if (target instanceof Element) elements = [target];
  else if (target && typeof target.length === 'number') elements = target;
  else return;

  Array.from(elements).forEach(el => {
    const chars = splitTextForAnimation(el);
    if (!chars.length) return;

    const fromVars = Object.assign({}, opts.from);
    const toVars = Object.assign({}, opts.to, {
      duration: opts.duration,
      ease: opts.ease,
      stagger: opts.delay
    });

    if (opts.useScrollTrigger && window.ScrollTrigger) {
      const startPct = (1 - (opts.threshold || 0.2)) * 100;
      const marginVal = typeof opts.rootMargin === 'number'
        ? opts.rootMargin
        : parseFloat(opts.rootMargin || 0) || 0;
      const sign = marginVal === 0 ? '' : (marginVal < 0 ? `-=${Math.abs(marginVal)}px` : `+=${marginVal}px`);
      const start = `top ${startPct}%${sign}`;

      toVars.scrollTrigger = {
        trigger: el,
        start: start,
        once: true,
        toggleActions: 'play none none none'
      };
    }

    gsap.fromTo(chars, fromVars, toVars);
  });
}

function animateContent(target, options) {
  if (!window.gsap) return;

  const opts = Object.assign({
    distance: 100,
    direction: 'vertical',
    reverse: false,
    duration: 0.8,
    ease: 'power3.out',
    initialOpacity: 0,
    animateOpacity: true,
    scale: 1,
    threshold: 0.1,
    delay: 0,
    stagger: 0.08,
    useScrollTrigger: false,
    onComplete: null
  }, options || {});

  let elements;
  if (typeof target === 'string') elements = document.querySelectorAll(target);
  else if (target instanceof Element) elements = [target];
  else if (target && typeof target.length === 'number') elements = target;
  else return;

  elements = Array.from(elements);
  elements.forEach((el, index) => {
    const axis = opts.direction === 'horizontal' ? 'x' : 'y';
    const offset = (opts.reverse ? -1 : 1) * (opts.distance || 100);

    const fromVars = {
      [axis]: offset,
      scale: opts.scale,
      opacity: opts.animateOpacity ? opts.initialOpacity : 1
    };

    const toVars = {
      [axis]: 0,
      scale: 1,
      opacity: 1,
      duration: opts.duration,
      ease: opts.ease,
      delay: (opts.delay || 0) + (opts.stagger || 0) * index
    };

    if (typeof opts.onComplete === 'function' && index === elements.length - 1) {
      toVars.onComplete = opts.onComplete;
    }

    if (opts.useScrollTrigger && window.ScrollTrigger) {
      const startPct = (1 - (opts.threshold || 0.1)) * 100;
      toVars.scrollTrigger = {
        trigger: el,
        start: `top ${startPct}%`,
        toggleActions: 'play none none none',
        once: true
      };
    }

    gsap.fromTo(el, fromVars, toVars);
  });
}

/* ========== CONFIG / M√ÅSCARAS / UTILS ========== */
const CONFIG = {
  API_URL: 'https://script.google.com/macros/s/AKfycbx7foVrZRKAjUsM-kf5ElbaNP-MsQbBoFofFGfVAVJgCNtdcEH6BGRiAOe3BFmGnlQo/exec',
  LOCAL_KEY: 'vitaclin_indicacoes_v3',
  ADMIN_PASS: '13102712',
  USED_COUPONS_KEY: 'vitaclin_cupons_usados_v1'
};

const CouponStore = {
  load() {
    try { return JSON.parse(localStorage.getItem(CONFIG.USED_COUPONS_KEY) || '[]'); }
    catch(e){ return []; }
  },
  save(list) {
    localStorage.setItem(CONFIG.USED_COUPONS_KEY, JSON.stringify(list || []));
  },
  has(code) { return this.load().includes(code); },
  add(code) {
    const list = this.load();
    if (!list.includes(code)) {
      list.push(code);
      this.save(list);
    }
  }
};

const Masks = {
  cpf: (el) => {
    let v = el.value.replace(/\D/g, '');
    if(v.length > 11) v = v.slice(0, 11);
    v = v.replace(/(\d{3})(\d)/, '$1.$2')
         .replace(/(\d{3})(\d)/, '$1.$2')
         .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    el.value = v;
  },
  phone: (el) => {
    let v = el.value.replace(/\D/g, '');
    if(v.length > 11) v = v.slice(0, 11);
    v = v.replace(/^(\d{2})(\d)/g, '($1) $2')
         .replace(/(\d)(\d{4})$/, '$1-$2');
    el.value = v;
  },
  date: (el) => {
    let v = el.value.replace(/\D/g, '');
    if (v.length > 8) v = v.slice(0, 8);
    if (v.length >= 5) {
      el.value = v.replace(/(\d{2})(\d{2})(\d{0,4}).*/, '$1/$2/$3');
    } else if (v.length >= 3) {
      el.value = v.replace(/(\d{2})(\d{0,2}).*/, '$1/$2');
    } else {
      el.value = v;
    }
  }
};

const Utils = {
  isValidPhone(digits) {
    const v = (digits || '').replace(/\D/g, '');
    if (v.length < 10) return false;
    if (/^(\d)\1+$/.test(v)) return false;
    return true;
  },

  /* permite tanto yyyy-mm-dd quanto dd/mm/aaaa ou dd-mm-aaaa */
  parseBirthDate(value) {
    const v = (value || '').trim();
    if (!v) return null;

    // formato padr√£o input date
    if (/^\d{4}-\d{2}-\d{2}$/.test(v)) {
      const d = new Date(v + 'T00:00:00');
      if (!isNaN(d.getTime())) return d;
      return null;
    }

    // formatos dd/mm/aaaa ou dd-mm-aaaa
    const m = v.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if (!m) return null;

    const dia = parseInt(m[1], 10);
    const mes = parseInt(m[2], 10) - 1;
    const ano = parseInt(m[3], 10);

    const d = new Date(ano, mes, dia);
    if (d.getFullYear() !== ano || d.getMonth() !== mes || d.getDate() !== dia) {
      return null;
    }
    return d;
  },

  formatDateISO(date) {
    if (!(date instanceof Date) || isNaN(date.getTime())) return '';
    return date.toISOString().slice(0, 10);
  }
};

/* ========== APP PRINCIPAL ========== */
const App = {
  init: () => {
    App.renderIndicadosInputs();
  },

  goTo(step) {
    if (step === 7 && prompt('Senha Admin:') !== CONFIG.ADMIN_PASS) {
      alert('Senha incorreta.');
      return;
    }

    const navLinks = document.querySelectorAll('header nav a[data-step]');
    navLinks.forEach(a => a.classList.remove('dock-active'));
    const currentLink = document.querySelector(`header nav a[data-step="${step}"]`);
    if (currentLink) currentLink.classList.add('dock-active');

    document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
    const section = document.querySelector(`.step-section[data-step="${step}"]`);
    if (section) section.classList.add('active');

    if (typeof Carousel !== 'undefined' && Carousel) {
      if (step === 2) {
        setTimeout(() => {
          Carousel.recalcWidth && Carousel.recalcWidth();
          Carousel.update && Carousel.update();
        }, 0);
        Carousel.startAutoplay && Carousel.startAutoplay();
      } else {
        Carousel.stopAutoplay && Carousel.stopAutoplay();
      }
    }

    window.scrollTo({ top: 0, behavior: 'smooth' });

    if (step === 7) {
      Admin.renderLocal();
      Admin.fetchAll();
    }

    if (window.gsap && typeof App.animateCurrentStep === 'function') {
      App.animateCurrentStep(step);
    }
  },

  checkAdmin: () => App.goTo(7),

  renderIndicadosInputs: () => {
    const container = document.getElementById('indicadosContainer');
    if(!container) return;
    let html = '';
    for(let i=1; i<=10; i++) {
      const req = i <= 2; // 2 obrigat√≥rios
      const labelStyle = req ? 'background:rgba(15,118,110,0.1); color:#0f766e;' : '';
      html += `
        <div class="indicado-item">
          <div class="indicado-header">
            <span>#${i} indicado</span>
            <span class="indicado-tag" style="${labelStyle}">${req?'Obrigat√≥rio':'Opcional'}</span>
          </div>
          <div class="field-group">
            <label>Nome completo</label>
            <input type="text" name="ind_nome_${i}">
          </div>
          <div class="field-row-2">
            <div class="field-group">
              <label>WhatsApp</label>
              <input type="tel" name="ind_whats_${i}" oninput="Masks.phone(this)" placeholder="(99) 99999-9999">
            </div>
            <div class="field-group">
              <label>Instagram (ex: @usuario)</label>
              <input type="text" name="ind_insta_${i}" placeholder="@usuario">
            </div>
          </div>
        </div>`;
    }
    container.innerHTML = html;
  },

  validateStep4: () => {
    const nome  = document.getElementById('nomeIndicador').value.trim();
    const cpf   = document.getElementById('cpfIndicador').value.replace(/\D/g,'');
    const whatsDigits = document.getElementById('whatsIndicador').value.replace(/\D/g,'');

    const instaInput = document.getElementById('instaIndicador');
    const instaRaw = instaInput.value.trim();
    const instaSemEspaco = instaRaw.replace(/\s+/g, '');
    const instaLimpo = instaSemEspaco.replace(/^@+/, '');
    const nascStr = document.getElementById('nascIndicador').value.trim();

    if (!nome) return alert('Preencha o seu nome completo.');

    if (!instaLimpo) {
      return alert('Informe seu Instagram (ex: @usuario), sem espa√ßos.');
    }

    if (cpf.length !== 11) return alert('CPF incompleto.');
    if (!Utils.isValidPhone(whatsDigits)) return alert('Informe um WhatsApp v√°lido.');

    if (!nascStr) return alert('Preencha sua data de nascimento.');
    const nascDate = Utils.parseBirthDate(nascStr);
    if (!nascDate) return alert('Data de nascimento inv√°lida. Use o formato dd/mm/aaaa.');

    const hoje = new Date();
    const minAno = hoje.getFullYear() - 110;
    if (nascDate.getFullYear() < minAno || nascDate > hoje) {
      return alert('Data de nascimento fora do intervalo permitido.');
    }

    // Normaliza o campo para @usuario
    instaInput.value = '@' + instaLimpo;

    App.goTo(6);
  },

  followAndContinue: () => {
    window.open(
      'https://www.instagram.com/vitaclinsaude?utm_source=ig_web_button_share_sheet&igsh=ZDNlZDc0MzIxNw==',
      '_blank',
      'noopener,noreferrer'
    );
  },

  copyCouponAndShowFollow: (code) => {
    navigator.clipboard.writeText(code).then(() => {
      alert('Cupom copiado!');
      App.goTo(5);
    }).catch(() => {
      alert('N√£o foi poss√≠vel copiar automaticamente. Mas voc√™ pode anotar este c√≥digo: ' + code);
      App.goTo(5);
    });
  },

  makeUniqueCoupon: (base) => {
    let candidate = base || ('VITA-' + Math.floor(Math.random()*9999).toString().padStart(4,'0'));
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let tries = 0;
    while (CouponStore.has(candidate) && tries < 50) {
      const extra = chars[Math.floor(Math.random()*chars.length)] +
                    chars[Math.floor(Math.random()*chars.length)];
      candidate = (base || 'VITA-') + extra;
      tries++;
    }
    CouponStore.add(candidate);
    return candidate;
  },

  handleSubmit: async (e) => {
    e.preventDefault();
    const alertBox  = document.getElementById('alert');
    const submitBtn = document.getElementById('submitBtn');
    const resultBox = document.getElementById('resultBox');

    alertBox.style.display  = 'none';
    resultBox.style.display = 'none';
    submitBtn.disabled      = true;
    submitBtn.innerHTML     = '‚è≥ Enviando...';

    try {
      const indicados = [];
      for(let i=1; i<=10; i++) {
        const nEl = document.querySelector(`[name="ind_nome_${i}"]`);
        const wEl = document.querySelector(`[name="ind_whats_${i}"]`);
        const igEl= document.querySelector(`[name="ind_insta_${i}"]`);

        const n  = nEl ? nEl.value.trim() : '';
        const w  = wEl ? wEl.value.replace(/\D/g,'') : '';
        const igRaw = igEl ? igEl.value.trim() : '';

        const igNormalizado = igRaw.replace(/\s+/g, '');
        let igClean = '';
        if (igNormalizado) {
          igClean = igNormalizado.startsWith('@')
            ? igNormalizado
            : '@' + igNormalizado.replace(/^@+/, '');
        }

        const algumPreenchido = n || w || igClean;

        if (algumPreenchido) {
          if (!n || !igClean) {
            throw new Error(`Preencha nome e Instagram (ex: @usuario, sem espa√ßos) do indicado #${i}.`);
          }
          if (!Utils.isValidPhone(w)) {
            throw new Error(`Informe um WhatsApp v√°lido para o indicado #${i}.`);
          }
          indicados.push({ nome: n, whatsapp: w, instagram: igClean });
        }
      }

      if(indicados.length < 2) {
        throw new Error('Indique pelo menos 2 pessoas completas (nome, WhatsApp e Instagram).');
      }

      const instaLower = indicados.map(i => (i.instagram || '').toLowerCase()).filter(Boolean);
      const instaRep = instaLower.find((ig, idx) => instaLower.indexOf(ig) !== idx);
      if (instaRep) {
        throw new Error('O Instagram das pessoas indicadas n√£o pode se repetir. Use um Instagram diferente para cada indicado.');
      }

      const nomeIndicador      = document.getElementById('nomeIndicador').value.trim();
      const cpfIndicador       = document.getElementById('cpfIndicador').value;
      const nascIndicadorRaw   = document.getElementById('nascIndicador').value.trim();
      const whatsIndicador     = document.getElementById('whatsIndicador').value;
      const emailIndicador     = document.getElementById('emailIndicador').value;
      const instaField         = document.getElementById('instaIndicador').value.trim();

      const instaIndicador = (function(v) {
        const semEspaco = v.replace(/\s+/g, '');
        if (!semEspaco) return '';
        if (semEspaco.startsWith('@')) return semEspaco;
        return '@' + semEspaco.replace(/^@+/, '');
      })(instaField);

      let nascIndicadorISO = nascIndicadorRaw;
      const parsedNasc = Utils.parseBirthDate(nascIndicadorRaw);
      if (parsedNasc) {
        nascIndicadorISO = Utils.formatDateISO(parsedNasc);
      }

      const payload = {
        type: 'indicacao',
        origem: 'landing-v3',
        cliente: {
          nome:           nomeIndicador,
          cpf:            cpfIndicador,
          dataNascimento: nascIndicadorISO,
          whatsapp:       whatsIndicador,
          email:          emailIndicador,
          instagram:      instaIndicador
        },
        indicados: indicados
      };

      const resp = await fetch(CONFIG.API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if(!data.ok && !data.indicacao) throw new Error(data.error || 'Erro ao salvar.');

      const info  = data.indicacao || {};
      const cupomBase = info.cupom || info.id || ('VITA-' + Math.floor(Math.random()*9999).toString().padStart(4,'0'));
      const cupom = App.makeUniqueCoupon(cupomBase);

      const qtd   = indicados.length;

      let faixa = '0%';
      if (qtd >= 2 && qtd <= 4) faixa = '10%';
      else if (qtd >= 5 && qtd <= 7) faixa = '12%';
      else if (qtd >= 8) faixa = '15%';

      Admin.saveLocal({
        ...payload.cliente,
        cupom,
        qtd,
        faixa,
        indicados,
        data: new Date().toISOString()
      });

      const resultBox2 = document.getElementById('resultBox');
      resultBox2.innerHTML = `
        <div style="font-size:16px; margin-bottom:8px;">üéâ <strong>Sucesso!</strong></div>
        <div>Voc√™ indicou ${qtd} pessoas e gerou seu desconto de <strong>${faixa}</strong>.</div>
        <div style="margin-top:6px;">
          C√≥digo: <span class="result-code">${cupom}</span>
          <button type="button" class="copy-code-btn"
                  style="margin-left:8px; border:none; border-radius:999px; padding:6px 12px; font-size:11px; font-weight:600; background:#111827; color:#fff; cursor:pointer;"
                  onclick="App.copyCouponAndShowFollow('${cupom}')">
            Copiar
          </button>
        </div>
        <div style="font-size:11px; margin-top:8px; color:#065f46">
          Tire um print desta tela e mostre na recep√ß√£o ao utilizar o desconto.
        </div>
        <div style="font-size:11px; margin-top:6px; color:#065f46;">
          Lembre-se: para que os descontos sejam aplicados, voc√™ tamb√©m precisa orientar seus indicados a seguir o Instagram oficial <strong>@vitaclinsaude</strong> antes do atendimento.
        </div>
        <div style="font-size:11px; margin-top:6px; color:#7f1d1d; background:#fef2f2; border-radius:10px; padding:8px;">
          ‚ö†Ô∏è Em casos de uso indevido ou tentativa de spam (mais de 3 cupons gerados no mesmo m√™s pela mesma pessoa, considerando nome, CPF e WhatsApp),
          os descontos podem ser suspensos para o indicador.
        </div>
      `;
      resultBox2.style.display = 'block';
      submitBtn.style.display = 'none';
      document.querySelector('.indicados-panel').style.display = 'none';

    } catch (err) {
      const alertBox2  = document.getElementById('alert');
      const submitBtn2 = document.getElementById('submitBtn');
      alertBox2.textContent   = err.message;
      alertBox2.style.display = 'block';
      submitBtn2.disabled     = false;
      submitBtn2.innerHTML    = '<span class="icon">üé´</span> Tentar Novamente';
    }
  }
};

/* anima√ß√µes por etapa */
App.animateCurrentStep = function(step) {
  if (!window.gsap) return;
  const section = document.querySelector(`.step-section[data-step="${step}"]`);
  if (!section) return;

  if (step === 1) {
    splitTextAndAnimate('.hero-title', {
      delay: 0.03,
      duration: 0.45,
      from: { opacity: 0, y: 40 },
      to:   { opacity: 1, y: 0 },
      useScrollTrigger: false
    });

    animateContent('.hero-right', {
      distance: 120,
      direction: 'horizontal',
      duration: 1.0,
      ease: 'power3.out',
      initialOpacity: 0,
      animateOpacity: true,
      scale: 1.02,
      delay: 0.05,
      useScrollTrigger: false
    });

    animateContent('.hero-perks > div', {
      distance: 80,
      direction: 'vertical',
      duration: 0.9,
      ease: 'power3.out',
      initialOpacity: 0,
      animateOpacity: true,
      scale: 1,
      delay: 0.15,
      stagger: 0.06,
      useScrollTrigger: false
    });

    return;
  }

  if (step === 2) {
    animateContent(section.querySelectorAll('.carousel-container'), {
      distance: 140,
      direction: 'vertical',
      duration: 1.0,
      ease: 'power3.out',
      initialOpacity: 0,
      animateOpacity: true,
      scale: 1,
      delay: 0.05,
      stagger: 0.08,
      useScrollTrigger: false
    });
  } else if (step === 3) {
    animateContent(section.querySelectorAll('.proc-block'), {
      distance: 130,
      direction: 'horizontal',
      duration: 1.0,
      ease: 'power3.out',
      initialOpacity: 0,
      animateOpacity: true,
      scale: 1.02,
      delay: 0.05,
      stagger: 0.08,
      useScrollTrigger: false
    });
  } else if (step === 4) {
    animateContent(section.querySelectorAll('.form-card'), {
      distance: 140,
      direction: 'vertical',
      duration: 1.0,
      ease: 'power3.out',
      initialOpacity: 0,
      animateOpacity: true,
      scale: 1.01,
      delay: 0.05,
      stagger: 0.08,
      useScrollTrigger: false
    });
  } else if (step === 5) {
    animateContent(section.querySelectorAll('.form-card'), {
      distance: 130,
      direction: 'vertical',
      duration: 0.9,
      ease: 'power3.out',
      initialOpacity: 0,
      animateOpacity: true,
      scale: 1.02,
      delay: 0.05,
      stagger: 0.08,
      useScrollTrigger: false
    });
  } else if (step === 6) {
    animateContent(section.querySelectorAll('.form-card, .indicados-panel'), {
      distance: 140,
      direction: 'vertical',
      duration: 1.0,
      ease: 'power3.out',
      initialOpacity: 0,
      animateOpacity: true,
      scale: 1.01,
      delay: 0.05,
      stagger: 0.08,
      useScrollTrigger: false
    });
  } else if (step === 7) {
    animateContent(section.querySelectorAll('.admin-panel'), {
      distance: 160,
      direction: 'vertical',
      duration: 1.1,
      ease: 'power3.out',
      initialOpacity: 0,
      animateOpacity: true,
      scale: 1,
      delay: 0.05,
      stagger: 0.08,
      useScrollTrigger: false
    });
  }
};

/* ========== CARROSSEL ========== */
const Carousel = {
  items: [
    {
      icon: '1',
      title: 'Voc√™ preenche seus dados',
      description: 'Informe nome completo, CPF, data de nascimento, WhatsApp, e-mail e Instagram (ex: @usuario). Esses dados identificam quem gerou as indica√ß√µes e garantem que o desconto ser√° aplicado para a pessoa certa.'
    },
    {
      icon: '2',
      title: 'Voc√™ indica de 2 a 10 pessoas',
      description: 'Adicione nome, n√∫mero de WhatsApp e Instagram (ex: @usuario) de conhecidos ou familiares que podem realizar exames ou atendimentos na Vitaclin. Menos de 2 indica√ß√µes n√£o gera desconto. Como indicador, voc√™ tamb√©m precisa orientar essas pessoas a seguir o Instagram oficial @vitaclinsaude para que todos consigam aproveitar corretamente os descontos.'
    },
    {
      icon: '3',
      title: 'Desconto para voc√™ e para os indicados',
      description: 'Voc√™ ganha de 10% a 15% de desconto em servi√ßos privados eleg√≠veis, conforme a quantidade de pessoas indicadas. Cada pessoa indicada recebe 5% de desconto em 1 servi√ßo privado eleg√≠vel, ao informar seu nome na recep√ß√£o, sem acumular com o seu desconto de 10% ou 15% no mesmo atendimento.'
    },
    {
      icon: '4',
      title: 'Valida√ß√£o pela equipe Vitaclin',
      description: 'Na hora do atendimento, a recep√ß√£o confere se o indicado est√° no nosso banco de dados vinculado a voc√™ e, se necess√°rio, verifica se segue o perfil @vitaclinsaude. Tudo de forma clara e segura.'
    }
  ],
  currentIndex: 0,
  autoplay: true,
  delay: 3000,
  timer: null,
  slideWidth: 0,

  recalcWidth() {
    const container = document.getElementById('benefitsCarousel');
    if (!container) return;
    const track = container.querySelector('.carousel-track');
    if (!track) return;

    const totalWidth = container.clientWidth || container.getBoundingClientRect().width;
    if (!totalWidth) return;

    const innerWidth = Math.max(totalWidth - 32, 260);

    this.slideWidth = innerWidth;

    track.style.width = (innerWidth * this.items.length) + 'px';
    const items = track.querySelectorAll('.carousel-item');
    items.forEach(item => {
      item.style.flex = '0 0 ' + innerWidth + 'px';
    });
  },

  init() {
    const container = document.getElementById('benefitsCarousel');
    if (!container) return;
    const track = container.querySelector('.carousel-track');
    const indicators = container.querySelector('.carousel-indicators');
    if (!track || !indicators) return;

    track.innerHTML = '';
    indicators.innerHTML = '';

    this.items.forEach((item, index) => {
      const card = document.createElement('div');
      card.className = 'carousel-item';
      card.innerHTML = `
        <div class="carousel-item-header">
          <span class="carousel-icon-container">
            <span class="carousel-icon">${item.icon || ''}</span>
          </span>
        </div>
        <div class="carousel-item-content">
          <div class="carousel-item-title">${item.title}</div>
          <p class="carousel-item-description">${item.description}</p>
        </div>
      `;
      track.appendChild(card);

      const dot = document.createElement('div');
      dot.className = 'carousel-indicator' + (index === 0 ? ' active' : ' inactive');
      dot.addEventListener('click', () => {
        Carousel.goTo(index);
      });
      indicators.appendChild(dot);
    });

    this.recalcWidth();
    this.update();

    container.addEventListener('mouseenter', () => this.stopAutoplay());
    container.addEventListener('mouseleave', () => this.startAutoplay());

    let startX = 0;
    let deltaX = 0;
    let isDragging = false;

    const onTouchStart = (e) => {
      if (!e.touches || e.touches.length === 0) return;
      startX = e.touches[0].clientX;
      deltaX = 0;
      isDragging = true;
      Carousel.stopAutoplay();
    };

    const onTouchMove = (e) => {
      if (!isDragging) return;
      if (!e.touches || e.touches.length === 0) return;
      const x = e.touches[0].clientX;
      deltaX = x - startX;

      const width = Carousel.slideWidth || container.getBoundingClientRect().width;
      const base = -Carousel.currentIndex * width;

      track.style.transition = 'none';
      track.style.transform = `translateX(${base + deltaX}px)`;
    };

    const onTouchEnd = () => {
      if (!isDragging) return;
      isDragging = false;

      const width = Carousel.slideWidth || container.getBoundingClientRect().width;
      const threshold = width * 0.2;

      track.style.transition = '';

      if (Math.abs(deltaX) > threshold) {
        if (deltaX < 0) Carousel.next();
        else Carousel.prev();
      } else {
        Carousel.update();
      }
      Carousel.startAutoplay();
    };

    container.addEventListener('touchstart', onTouchStart, { passive: true });
    container.addEventListener('touchmove',  onTouchMove,  { passive: true });
    container.addEventListener('touchend',   onTouchEnd);
    container.addEventListener('touchcancel', onTouchEnd);

    window.addEventListener('resize', () => {
      Carousel.recalcWidth();
      Carousel.update();
    });
  },

  update() {
    const container = document.getElementById('benefitsCarousel');
    if (!container) return;
    const track = container.querySelector('.carousel-track');
    if (!track) return;

    if (!this.slideWidth) this.recalcWidth();
    const width = this.slideWidth;

    track.style.transition = 'transform 0.6s cubic-bezier(0.22, 0.61, 0.36, 1)';
    track.style.transform = `translateX(-${this.currentIndex * width}px)`;

    const dots = container.querySelectorAll('.carousel-indicator');
    dots.forEach((dot, idx) => {
      dot.classList.toggle('active', idx === this.currentIndex);
      dot.classList.toggle('inactive', idx !== this.currentIndex);
    });
  },

  goTo(index) {
    if (index < 0 || index >= this.items.length) return;
    this.currentIndex = index;
    this.update();
  },

  next() {
    this.currentIndex = (this.currentIndex + 1) % this.items.length;
    this.update();
  },

  prev() {
    this.currentIndex = (this.currentIndex - 1 + this.items.length) % this.items.length;
    this.update();
  },

  startAutoplay() {
    if (!this.autoplay || this.timer) return;
    this.timer = setInterval(() => this.next(), this.delay);
  },

  stopAutoplay() {
    if (this.timer) {
      clearInterval(this.timer);
      this.timer = null;
    }
  }
};

/* ========== MAGIC PROCEDURES ========== */
const MagicProcedures = {
  _initialized: false,

  init() {
    if (this._initialized) return;
    this._initialized = true;

    const cards = document.querySelectorAll('.proc-block');
    if (!cards.length) return;

    cards.forEach(card => {
      if (!card.style.getPropertyValue('--glow-intensity')) {
        card.style.setProperty('--glow-intensity', '0');
      }
    });

    const isMobile = window.innerWidth <= 999;

    // Fun√ß√£o de clique verde (desktop + mobile)
    function spawnClickWave(card, clientX, clientY) {
      const rect   = card.getBoundingClientRect();
      const localX = clientX - rect.left;
      const localY = clientY - rect.top;

      // foco no ponto do clique
      card.style.setProperty('--glow-x', `${(localX / rect.width) * 100}%`);
      card.style.setProperty('--glow-y', `${(localY / rect.height) * 100}%`);
      card.style.setProperty('--glow-intensity', '1');
      card.classList.add('magic-proc-active');

      // onda verde forte
      const maxDist = Math.max(
        Math.hypot(localX, localY),
        Math.hypot(localX - rect.width, localY),
        Math.hypot(localX, localY - rect.height),
        Math.hypot(localX - rect.width, localY - rect.height)
      );
      const wave = document.createElement('div');
      wave.className = 'proc-click-wave';
      wave.style.left  = localX + 'px';
      wave.style.top   = localY + 'px';
      const size = maxDist * 2;
      wave.style.width  = size + 'px';
      wave.style.height = size + 'px';
      card.appendChild(wave);

      if (window.gsap) {
        gsap.fromTo(wave,
          { scale: 0, opacity: 0.98 },
          {
            scale: 1,
            opacity: 0,
            duration: 0.6,
            ease: 'power2.out',
            onComplete: () => wave.remove()
          }
        );
      } else {
        wave.style.transition = 'transform 0.5s ease-out, opacity 0.5s ease-out';
        requestAnimationFrame(() => {
          wave.style.transform = 'translate(-50%, -50%) scale(1)';
          wave.style.opacity = '0';
        });
        setTimeout(() => wave.remove(), 600);
      }

      // diminui o brilho depois de um tempinho
      setTimeout(() => {
        card.classList.remove('magic-proc-active');
        card.style.setProperty('--glow-intensity', '0.25');
        setTimeout(() => {
          card.style.setProperty('--glow-intensity', '0');
        }, 200);
      }, 350);
    }

    if (!isMobile) {
      // DESKTOP: hover + tilt + clique verde
      cards.forEach(card => {
        card.addEventListener('mousemove', (e) => {
          const rect = card.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          const centerX = rect.width / 2;
          const centerY = rect.height / 2;

          const rotateX = ((y - centerY) / centerY) * -6;
          const rotateY = ((x - centerX) / centerX) * 6;

          card.style.setProperty('--glow-x', `${(x / rect.width) * 100}%`);
          card.style.setProperty('--glow-y', `${(y / rect.height) * 100}%`);
          card.style.setProperty('--glow-intensity', '1');

          if (window.gsap) {
            gsap.to(card, {
              rotateX,
              rotateY,
              duration: 0.18,
              ease: 'power2.out',
              transformPerspective: 800
            });
          }
        });

        card.addEventListener('mouseleave', () => {
          card.style.setProperty('--glow-intensity', '0');
          if (window.gsap) {
            gsap.to(card, {
              rotateX: 0,
              rotateY: 0,
              x: 0,
              y: 0,
              duration: 0.28,
              ease: 'power2.out'
            });
          }
        });

        card.addEventListener('click', (e) => {
          spawnClickWave(card, e.clientX, e.clientY);
        });
      });

      return;
    }

    // MOBILE: clique + foco + long-press para magnetismo
    let activeCard = null;
    let longPressTimer = null;
    let startTouch = null;
    const LONG_PRESS_MS = 260;
    const MOVE_TOL = 10;

    function cancelLongPress() {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
    }

    function resetCard(card) {
      card.classList.remove('magic-proc-active');
      card.style.setProperty('--glow-intensity', '0');
      if (window.gsap) {
        gsap.to(card, {
          x: 0,
          y: 0,
          scale: 1,
          duration: 0.28,
          ease: 'power3.out'
        });
      }
    }

    cards.forEach(card => {
      card.addEventListener('touchstart', (e) => {
        if (!e.touches || !e.touches.length) return;
        const t = e.touches[0];
        startTouch = { x: t.clientX, y: t.clientY, card };

        cancelLongPress();

        // LONG PRESS ‚Üí ativa magnetismo e foco no ponto pressionado
        longPressTimer = setTimeout(() => {
          if (!startTouch || startTouch.card !== card) return;

          activeCard = card;
          card.classList.add('magic-proc-active');

          const rect   = card.getBoundingClientRect();
          const localX = startTouch.x - rect.left;
          const localY = startTouch.y - rect.top;

          card.style.setProperty('--glow-x', `${(localX / rect.width) * 100}%`);
          card.style.setProperty('--glow-y', `${(localY / rect.height) * 100}%`);
          card.style.setProperty('--glow-intensity', '1');

          if (window.gsap) {
            gsap.to(card, {
              y: -10,
              scale: 1.03,
              duration: 0.2,
              ease: 'power2.out'
            });
          }
        }, LONG_PRESS_MS);
      }, { passive: true });

      card.addEventListener('touchmove', (e) => {
        if (!e.touches || !e.touches.length) return;
        const t = e.touches[0];

        if (!activeCard && startTouch) {
          const dx = t.clientX - startTouch.x;
          const dy = t.clientY - startTouch.y;
          if (Math.hypot(dx, dy) > MOVE_TOL) {
            // movimentou muito antes do long-press ‚Üí cancela
            cancelLongPress();
            startTouch = null;
            return;
          }
        }

        if (activeCard === card && startTouch) {
          const dx = t.clientX - startTouch.x;
          const dy = t.clientY - startTouch.y;

          if (window.gsap) {
            gsap.to(card, {
              x: dx * 0.08,
              y: -10 + dy * 0.08,
              duration: 0.16,
              ease: 'power2.out'
            });
          }
        }
      }, { passive: true });

      const end = (e) => {
        // TOQUE R√ÅPIDO (sem long-press) ‚Üí clique + foco + onda verde
        if (!activeCard && startTouch && e && e.changedTouches && e.changedTouches[0]) {
          const t = e.changedTouches[0];
          spawnClickWave(card, t.clientX, t.clientY);
        }

        cancelLongPress();
        startTouch = null;

        if (activeCard === card) {
          resetCard(card);
          activeCard = null;
        }
      };

      card.addEventListener('touchend', end);
      card.addEventListener('touchcancel', end);
    });

    // Tilt leve pelo girosc√≥pio quando N√ÉO est√° arrastando
    if (window.DeviceOrientationEvent) {
      window.addEventListener('deviceorientation', (event) => {
        if (activeCard) return;

        const beta = event.beta || 0;
        const gamma = event.gamma || 0;
        const maxTilt = 8;
        const rotateX = Math.max(Math.min(beta / 8, maxTilt), -maxTilt);
        const rotateY = Math.max(Math.min(gamma / 8, maxTilt), -maxTilt);

        if (window.gsap) {
          cards.forEach(card => {
            gsap.to(card, {
              rotateX: -rotateX,
              rotateY:  rotateY,
              duration: 0.3,
              ease: 'power2.out',
              transformPerspective: 800
            });
          });
        }
      });
    }
  }
};

/* ========== ADMIN ========== */
const Admin = {
  saveLocal: (data) => {
    const list = JSON.parse(localStorage.getItem(CONFIG.LOCAL_KEY) || '[]');
    list.push(data);
    localStorage.setItem(CONFIG.LOCAL_KEY, JSON.stringify(list));
  },

  clearLocal: () => {
    if(confirm('Apagar hist√≥rico local?')) {
      localStorage.removeItem(CONFIG.LOCAL_KEY);
      Admin.renderLocal();
    }
  },

  renderLocal: () => {
    const list = JSON.parse(localStorage.getItem(CONFIG.LOCAL_KEY) || '[]').reverse();
    const el   = document.getElementById('adminLocalList');
    const emptyMsg = document.getElementById('adminEmptyMsg');
    if(!el) return;

    if(!list.length) {
      el.innerHTML = '';
      if(emptyMsg) emptyMsg.style.display = 'block';
      return;
    }
    if(emptyMsg) emptyMsg.style.display = 'none';

    el.innerHTML = list.map(r => {
      const inds = (r.indicados||[])
        .map((ind, idx) => `${idx+1}. ${ind.nome} ‚Äî ${ind.whatsapp} ‚Äî ${ind.instagram}`)
        .join('\n');
      return `
        <div class="admin-card">
          <div class="admin-card-header">
            <div>
              <div class="admin-card-title">${r.nome}</div>
              <div class="admin-card-meta">
                CPF: ${r.cpf} ¬∑ Whats: ${r.whatsapp}<br>
                Insta: ${r.instagram}
              </div>
            </div>
            <div class="admin-badge">${r.qtd} indicado(s) ¬∑ ${r.faixa || '0%'}</div>
          </div>
          <div class="admin-card-meta">
            Cupom: <strong style="color:#4ade80; font-family:monospace">${r.cupom}</strong><br>
            Enviado em: ${new Date(r.data).toLocaleString()}
          </div>
          <div class="admin-card-indicados-title">Indicados:</div>
          <pre class="admin-card-indicados-list">${inds}</pre>
        </div>`;
    }).join('');
  },

  fetchAll: async () => {
    const statusDiv = document.getElementById('adminRemoteStatus');
    const container = document.getElementById('adminRemoteAll');
    if(statusDiv) statusDiv.textContent = 'Carregando dados da nuvem...';

    try {
      const resp = await fetch(CONFIG.API_URL + '?list_indicados=1');
      const data = await resp.json();
      const rows = data.rows || [];
      Admin.renderCloudList(rows, 'adminRemoteAll');
      if(statusDiv) statusDiv.textContent = `Carregado: ${rows.length} registros na nuvem.`;
    } catch(e) {
      if(statusDiv) statusDiv.textContent = 'Erro ao carregar dados da planilha.';
      if(container) container.innerHTML = '<div class="admin-empty">Falha ao carregar a nuvem.</div>';
    }
  },

  searchCloud: async () => {
    const indr = document.getElementById('adminIndicador').value;
    const indd = document.getElementById('adminIndicado').value;
    const w    = document.getElementById('adminWhats').value;
    const statusDiv = document.getElementById('adminRemoteStatus');

    if(statusDiv) statusDiv.textContent = 'Buscando na nuvem...';

    try {
      let url = `${CONFIG.API_URL}?search_indicado=1`;
      if(indr) url += `&indicador=${encodeURIComponent(indr)}`;
      if(indd) url += `&nome=${encodeURIComponent(indd)}`;
      if(w)    url += `&whats=${encodeURIComponent(w)}`;

      const resp = await fetch(url);
      const data = await resp.json();
      const results = data.results || [];
      Admin.renderCloudList(results, 'adminRemoteResults');
      if(statusDiv) statusDiv.textContent = `Busca conclu√≠da: ${results.length} resultado(s).`;
    } catch(e) {
      if(statusDiv) statusDiv.textContent = 'Erro na busca na nuvem.';
      const container = document.getElementById('adminRemoteResults');
      if(container) container.innerHTML = '<div class="admin-empty">Erro ao buscar.</div>';
    }
  },

  renderCloudList: (rows, containerId) => {
    const div = document.getElementById(containerId);
    if (!div) return;

    if (!rows || !rows.length) {
      div.innerHTML = '<div class="admin-empty">Nenhum registro encontrado.</div>';
      return;
    }

    const groups = {};
    rows.forEach(r => {
      const indicadorNome = r.nome_indicador || r.nomeIndicador || 'Sem indicador';
      const cupomGrupo = r.cupom || r.id_lote || r.id_indicacao || r.id || '';
      const key = indicadorNome + '|||' + (cupomGrupo || 'SEM-CUPOM');
      if (!groups[key]) groups[key] = [];
      groups[key].push(r);
    });

    let html = '<div class="admin-groups">';
    Object.keys(groups)
      .sort((a,b) => {
        const [nA, cA] = a.split('|||');
        const [nB, cB] = b.split('|||');
        if (nA < nB) return -1;
        if (nA > nB) return 1;
        if (cA < cB) return -1;
        if (cA > cB) return 1;
        return 0;
      })
      .forEach(key => {
        const list = groups[key];
        const first = list[0] || {};
        const partsKey = key.split('|||');
        const indicadorNome = partsKey[0];
        const cupomGrupoHint = partsKey[1];
        const cupomGrupo = first.cupom || first.id_lote || first.id_indicacao || first.id || (cupomGrupoHint === 'SEM-CUPOM' ? '' : cupomGrupoHint);

        const indicadorStatusRaw = (first.status_indicador || '').toString().toLowerCase();
        const indicadorResgatou  = indicadorStatusRaw.includes('resgat');

        const indicadorStatusLabel = indicadorResgatou
          ? 'Status do indicador: cupom j√° resgatado'
          : 'Status do indicador: em andamento';

        const indResgClass    = 'admin-indicado-btn' + (indicadorResgatou ? ' done' : '');
        const indResgDisabled = indicadorResgatou ? 'disabled' : '';
        const indResgText     = 'üéüÔ∏è J√° resgatou o cupom';

        html += `
          <div class="admin-group" data-indicador-nome="${indicadorNome}" data-cupom-grupo="${cupomGrupo}">
            <div class="admin-group-title">
              <span>${indicadorNome}</span>
              <span class="admin-indicador-tag">${list.length} indicado(s)</span>
            </div>
            <div class="admin-group-meta">
              Cupom deste grupo: <strong>${cupomGrupo || '‚Äî'}</strong><br>
              <strong>${indicadorStatusLabel}</strong>
            </div>

            <div class="admin-indicador-actions">
              <button type="button"
                      class="${indResgClass}"
                      data-indicator-status="resgatou"
                      ${indResgDisabled}
                      onclick="Admin.markIndicatorStatus('${indicadorNome.replace(/'/g, "\\'")}', 'resgatou', this)">
                ${indResgText}
              </button>
            </div>
        `;

        list.forEach(item => {
          const parts = [];
          if (item.whats_indicado)      parts.push(`Whats: ${item.whats_indicado}`);
          if (item.instagram_indicado)  parts.push(`IG: ${item.instagram_indicado}`);
          if (item.cupom || item.id_indicacao)
            parts.push(`Cupom: ${item.cupom || item.id_indicacao}`);
          if (item.status_contato)      parts.push(`Status: ${item.status_contato}`);
          if (item.desconto_indicado)   parts.push(`Desc. indicado: ${item.desconto_indicado}`);

          const rowId    = item.id_indicacao || item.id || item.cupom || '';
          const rowIndex = item.row_index || '';
          const cupomRow = item.cupom || item.id_indicacao || item.id || '';

          const statusRaw  = (item.status_contato || '').toString().toLowerCase();
          const isResgatou = statusRaw.includes('resgat') || statusRaw.includes('conclu');

          const resgClass    = 'admin-indicado-btn' + (isResgatou ? ' done' : '');
          const resgDisabled = isResgatou ? 'disabled' : '';

          html += `
            <div class="admin-indicado-row"
                 data-row-id="${rowId}"
                 data-row-index="${rowIndex}"
                 data-row-cupom="${cupomRow}">
              <span class="admin-indicado-name">${item.nome_indicado || item.nome}</span>
              <span class="admin-indicado-meta">${parts.join(' ‚Ä¢ ')}</span>
              <div class="admin-indicado-actions">
                <button type="button"
                        class="${resgClass}"
                        data-status="resgatou"
                        ${resgDisabled}
                        onclick="Admin.markStatus('${rowId}','resgatou', this)">
                  üéüÔ∏è J√° resgatou o cupom
                </button>
              </div>
            </div>`;
        });

        html += `</div>`;
      });

    html += '</div>';
    div.innerHTML = html;
  },

  markStatus: async (rowId, status, btn) => {
    if (!rowId) {
      alert('N√£o foi poss√≠vel identificar o registro na planilha.');
      return;
    }

    const statusDiv = document.getElementById('adminRemoteStatus');
    if (statusDiv) statusDiv.textContent = 'Atualizando status na planilha...';

    try {
      const rowEl    = btn ? btn.closest('.admin-indicado-row') : null;
      const rowIndex = rowEl && rowEl.dataset.rowIndex ? Number(rowEl.dataset.rowIndex) : null;
      const cupom    = rowEl && rowEl.dataset.rowCupom ? rowEl.dataset.rowCupom : null;

      const payload = { id: rowId, status };
      if (rowIndex) payload.row_index = rowIndex;
      if (cupom)    payload.cupom     = cupom;

      const resp = await fetch(CONFIG.API_URL + '?update_status=1', {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });

      const text = await resp.text();
      let data = {};
      try { data = JSON.parse(text); } catch (e) { data = {}; }

      if (!data || data.ok === false) {
        throw new Error(data && data.error ? data.error : 'Erro ao atualizar status no servidor.');
      }

      if (statusDiv) {
        statusDiv.textContent = 'Status do indicado atualizado na planilha como "j√° resgatou o cupom".';
      }

      if (btn) {
        btn.classList.add('done');
        btn.disabled = true;
        btn.textContent = 'üéüÔ∏è J√° resgatou o cupom';

        const row = btn.closest('.admin-indicado-row');
        if (row) {
          const meta = row.querySelector('.admin-indicado-meta');
          if (meta && !meta.textContent.includes('Marcado:')) {
            meta.textContent += ' ‚Ä¢ Marcado: j√° resgatou o cupom';
          }

          const group = row.closest('.admin-group');
          const indicadorNome = group && group.dataset.indicadorNome;
          if (indicadorNome) {
            Admin.markIndicatorStatus(indicadorNome, 'resgatou');
          }
        }
      }

    } catch (e) {
      console.error(e);
      const statusDiv2 = document.getElementById('adminRemoteStatus');
      if (statusDiv2) {
        statusDiv2.textContent = 'N√£o foi poss√≠vel confirmar o status no servidor. Verifique se o par√¢metro update_status est√° implementado no Apps Script.';
      }
      alert('Erro ao atualizar status na planilha. Confira o Apps Script.');
    }
  },

  markIndicatorStatus: async (indicadorNome, status, btn) => {
    if (!indicadorNome) {
      alert('N√£o foi poss√≠vel identificar o indicador.');
      return;
    }

    const statusDiv = document.getElementById('adminRemoteStatus');
    if (statusDiv) statusDiv.textContent = 'Atualizando status do indicador na planilha...';

    try {
      const payload = { indicador: indicadorNome, status };

      const resp = await fetch(CONFIG.API_URL + '?update_indicator_status=1', {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });

      const text = await resp.text();
      let data = {};
      try { data = JSON.parse(text); } catch (e) { data = {}; }

      if (!data || data.ok === false) {
        throw new Error(data && data.error ? data.error : 'Erro ao atualizar status do indicador no servidor.');
      }

      if (btn) {
        btn.classList.add('done');
        btn.disabled = true;
        btn.textContent = 'üéüÔ∏è J√° resgatou o cupom';
      }

      const group = btn ? btn.closest('.admin-group') : null;
      if (group) {
        const metaGroup = group.querySelector('.admin-group-meta');
        if (metaGroup) {
          metaGroup.innerHTML = `
            Cupom deste grupo: <strong>${group.dataset.cupomGrupo || '‚Äî'}</strong><br>
            <strong>Status do indicador: cupom j√° resgatado</strong>
          `;
        }
      }

      if (statusDiv) {
        statusDiv.textContent = `Status do indicador "${indicadorNome}" atualizado na planilha como "j√° resgatou o cupom".`;
      }

      Admin.fetchAll();

    } catch (e) {
      console.error(e);
      const statusDiv2 = document.getElementById('adminRemoteStatus');
      if (statusDiv2) {
        statusDiv2.textContent = 'N√£o foi poss√≠vel confirmar o status do indicador na nuvem. Verifique o Apps Script.';
      }
      alert('Erro ao atualizar status do indicador na planilha. Confira o Apps Script.');
    }
  }
};

/* ========== ON LOAD ========== */
window.addEventListener('load', function () {
  if (window.gsap && window.ScrollTrigger) {
    gsap.registerPlugin(ScrollTrigger);
  }
  App.init();
  if (typeof Carousel !== 'undefined' && Carousel.init) {
    Carousel.init();
  }
  if (typeof MagicProcedures !== 'undefined' && MagicProcedures.init) {
    MagicProcedures.init();
  }
  if (typeof App.goTo === 'function') {
    App.goTo(1);
  }

  const dockStyle = document.createElement('style');
  dockStyle.textContent = `
    nav.dock-nav a.dock-active {
      background: linear-gradient(135deg,
        rgba(243,227,211,0.98),
        rgba(205,162,121,0.98)
      ) !important;
      border-color: rgba(181,135,92,0.95) !important;
      color: #111827 !important;
    }
  `;
  if (document.head) document.head.appendChild(dockStyle);

  /* permitir DIGITAR a data no celular, com m√°scara e limite */
  (function() {
    const input = document.getElementById('nascIndicador');
    if (!input) return;

    const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (!isMobileUA) return;

    input.setAttribute('type', 'text');
    input.setAttribute('inputmode', 'numeric');
    input.setAttribute('autocomplete', 'bday');
    input.maxLength = 10; // dd/mm/aaaa ‚Üí 10 caracteres
    if (!input.placeholder) input.placeholder = 'dd/mm/aaaa';

    input.addEventListener('input', function () {
      let v = input.value.replace(/\D/g, '');
      if (v.length > 8) v = v.slice(0, 8); // m√°ximo 8 d√≠gitos (ddmmAAAA)

      if (v.length >= 5) {
        input.value = v.replace(/(\d{2})(\d{2})(\d{0,4}).*/, '$1/$2/$3');
      } else if (v.length >= 3) {
        input.value = v.replace(/(\d{2})(\d{0,2}).*/, '$1/$2');
      } else {
        input.value = v;
      }
    });
  })();

  /* evitar zoom de double-tap na etapa "Procedimentos que podem receber desconto" */
  (function() {
    const sec3 = document.querySelector('.step-section[data-step="3"]');
    if (!sec3) return;
    let lastTouch = 0;
    sec3.addEventListener('touchend', function(e) {
      const now = Date.now();
      if (now - lastTouch < 400) {
        e.preventDefault();
      }
      lastTouch = now;
    }, { passive: false });
  })();
});
</script>
</body>
</html>


